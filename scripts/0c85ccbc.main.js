function initData(a){return a.data=a.data.map(function(a){for(key in a)a[key]="Månad"==key?parseDate(a[key]):+a[key];return a}),a}function initCharts(){$(".chart").each(function(){var a=$(this),b=a.attr("id"),c=a.attr("data-columns").split(","),d={};a.hasAttr("data-charts")&&(d.charts=a.attr("data-charts").split(",")),a.hasAttr("data-month")&&"latest"!==a.attr("data-month")&&(d.date=parseDate(a.attr("data-month"))),a.hasAttr("data-width")&&(d.width=a.attr("data-width")),a.hasAttr("data-height")&&(d.width=a.attr("data-height")),charts[b]=new BarChart(b,c,d)})}function getQueryString(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b=new RegExp("[\\?&]"+a+"=([^&#]*)"),c=b.exec(location.search);return null===c?"":decodeURIComponent(c[1].replace(/\+/g," "))}function sameYearAndMonth(a,b){return a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()}function initChartBuilder(){var a=d3.nest().key(function(a){return a.category}).entries(d3.values(dataObj.columns).filter(function(a){return"Månad"!==a.name}).sort(function(a,b){return d3.ascending(a.name,b.name)})),b=Handlebars.compile($("#template-columns").html());$("#columns").html(b(a));var c=dataObj.data.map(function(a){return{name:formatMonthYear(a["Månad"]),value:formatYearMonthDay(a["Månad"])}}).sort(function(a,b){return d3.descending(a.value,b.value)});c.unshift({name:"Senaste månaden",value:"latest"});var d=Handlebars.compile($("#template-months").html());$("#months").html(d(c)),$("#columns").children("li").click(function(){var a=$(this);a.parent("#columns").find(":checked").prop("checked",!1),a.next("ul").find("input").prop("checked",!0),chartBuilderUpdate()})}function chartBuilderUpdate(){var a=$("#columns :checked").map(function(){return $(this).val()}).toArray(),b=$("#months").val(),c=$("#charts :checked").map(function(){return $(this).val()}).toArray(),d=$("#height").val(),e=window.location.href+"chart.html?columns="+a.join(",")+"&month="+b+"&charts="+c.join(",")+"&height="+d;$("#url").text(e),$("#iframe-parent iframe").remove();new pym.Parent("iframe-parent",e,{})}BarChart=function(){function a(a,b,c){var d=this;d.data=dataObj.data,d.columns=b,d.opts=jQuery.extend({width:"auto",height:300,charts:["today","change"],title:"",subtitle:"",date:d.data[d.data.length-1]["Månad"]},c),d.id="#"+a,d.columnDictionary=dataObj.columns,d.$el=$(d.id),d.chartContainers={},d.chartContainers.today=d.$el.append($("<div/>").attr("class","chart-today")),d.chartContainers.change=d.$el.append($("<div/>").attr("class","chart-change")),b&&0!=b.length||console.error("Error: Add an array of columns"),d.charts={},d.chartSetup={size:{},data:{x:"x",type:"bar"},axis:{x:{type:"category"},y:{tick:{}}}},$.inArray("today",c.charts)>-1&&d.drawTodayChart(),$.inArray("change",c.charts)>-1&&d.drawChangeChart()}return a.prototype.drawTodayChart=function(){var a=this,b=a.chartSetup;b.size.height=a.opts.height,b.bindto=a.id+" .chart-today",b.data.columns=a.getValues(),b.axis.y.tick.format=function(a){return formatPercent(a/100)},a.charts.today=c3.generate(b)},a.prototype.drawChangeChart=function(){var a=this,b=a.chartSetup;b.size.height=.7*a.opts.height,b.bindto=a.id+" .chart-change",b.data.columns=a.getValues("change");var c=.05,d=b.data.columns[1].slice(0);d.shift(),b.axis.y.min=Math.min(-c,d3.min(d)),b.axis.y.max=Math.max(c,d3.max(d)),b.axis.y.tick.format=function(a){return formatPercentSmall(a/100)},b.data.color=function(a,b){return b.value>0?"green":"red"},b.grid={y:{lines:[{value:0,text:""}]}},a.charts.change=c3.generate(b)},a.prototype.getValues=function(a){var b=this,c=b.data.first(function(a){return sameYearAndMonth(a["Månad"],b.opts.date)});0==c.length&&console.error("Date error");var d;if("change"==a){var e=b.opts.date.sameMonthLastYear();d=b.data.first(function(a){return sameYearAndMonth(a["Månad"],e)})}var f=["Arbetslöshet"],g=["x"];return b.columns.forEach(function(e){try{f.push("change"==a?c[e]-d[e]:c[e]),g.push(b.columnDictionary[e].name_short)}catch(h){console.error("Invalid column ("+e+" )",h)}}),[g,f]},a}();var locale=d3.locale({decimal:",",thousands:" ",grouping:[3],currency:[""," kr"],dateTime:"%A %e %B %Y kl. %X",date:"%d.%m.%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["måndag","tisdag","onsdag","torsdag","fredag","lördag","söndag"],shortDays:["må","ti","ons","to","fre","lö","sö"],months:["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"],shortMonths:["jan","feb","mars","apr","maj","jun","jul","aug","sept","okt","nov","dec"]}),parseDate=locale.timeFormat("%Y-%m-%d").parse;$.prototype.hasAttr=function(a){var b=$(this).attr(a);return"undefined"!=typeof b&&b!==!1},Array.prototype.first||(Array.prototype.first=function(a){"use strict";if(null==this)throw new TypeError;if("function"!=typeof a)throw new TypeError;for(var b=0;b<this.length;b++)if(a(this[b]))return this[b];return null}),Date.prototype.sameMonthLastYear=function(){return new Date(this.getFullYear()-1,this.getMonth(),1)};var formatPercent=locale.numberFormat(".1%"),formatPercentSmall=locale.numberFormat(".2%"),formatMonthYear=locale.timeFormat("%B %Y"),formatYearMonthDay=locale.timeFormat("%Y-%m-%d"),dataObj,charts={},key="1I7A8rydoRA6n28W6Tnt6nCpEYeUbI2J1dcVrEy54G7Y",mode="stage",dataUrl="https://s3-eu-west-1.amazonaws.com/tabletop-proxy/saco-arbetsmarknad-"+mode+"/"+key+".json";$.getJSON(dataUrl,function(a){dataObj=initData(a),initChartBuilder(),$("#columns ul").first().find("input").prop("checked",!0),chartBuilderUpdate()});